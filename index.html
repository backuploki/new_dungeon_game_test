<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>The Red Below</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; touch-action: none; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        
        #instructions {
            color: rgba(255,255,255,0.9); 
            background: rgba(0,0,0,0.6); 
            padding: 20px; border-radius: 10px;
            text-align: center;
            pointer-events: auto;
            border: 1px solid #444;
        }

        .thumb-zone {
            position: absolute; bottom: 40px; width: 140px; height: 140px;
            border: 2px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05);
            border-radius: 50%;
            pointer-events: none;
        }
        
        .stick-nub {
            position: absolute; top: 50%; left: 50%; width: 50px; height: 50px;
            background: rgba(255, 200, 0, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        #left-zone { left: 20px; }
        #right-zone { right: 20px; }
        .zone-label { position: absolute; bottom: -30px; width: 100%; text-align: center; color: #aaa; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>

<div id="ui-layer">
    <div id="instructions">
        <h2>THE RED BELOW</h2>
        <p>Find the door. Go down.</p>
    </div>
    <div id="left-zone" class="thumb-zone"><div class="stick-nub" id="left-nub"></div><div class="zone-label">WALK</div></div>
    <div id="right-zone" class="thumb-zone"><div class="stick-nub" id="right-nub"></div><div class="zone-label">LOOK</div></div>
</div>

<script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
    }
  }
</script>

<script type="module">
    import * as THREE from 'three';

    // --- 1. SETUP ---
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x050505, 0.06);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.rotation.order = 'YXZ'; 

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true; 
    document.body.appendChild(renderer.domElement);

    // --- 2. INPUT & CONTROLS ---
    const input = { moveX: 0, moveY: 0, lookX: 0, lookY: 0 };
    const LOOK_SENSITIVITY = 0.004; 
    const WALK_SPEED = 7.0;

    const leftNub = document.getElementById('left-nub');
    const rightNub = document.getElementById('right-nub');
    const instructions = document.getElementById('instructions');
    const touches = {}; 
    
    document.addEventListener('touchstart', (e) => { e.preventDefault(); instructions.style.display = 'none'; handleTouch(e); });
    document.addEventListener('touchmove', (e) => { e.preventDefault(); handleTouch(e); });
    document.addEventListener('touchend', endTouch);
    
    const halfWidth = window.innerWidth / 2;

    function handleTouch(e) {
        for (let i = 0; i < e.touches.length; i++) {
            const t = e.touches[i];
            if (!touches[t.identifier]) touches[t.identifier] = { startX: t.clientX, startY: t.clientY };
            const startX = touches[t.identifier].startX;
            const deltaX = t.clientX - startX;
            const deltaY = t.clientY - touches[t.identifier].startY;

            if (startX < halfWidth) { // Move
                input.moveX = Math.max(-1, Math.min(1, deltaX / 60)); 
                input.moveY = Math.max(-1, Math.min(1, deltaY / 60));
                leftNub.style.transform = `translate(calc(-50% + ${Math.max(-60,Math.min(60,deltaX))}px), calc(-50% + ${Math.max(-60,Math.min(60,deltaY))}px))`;
            } else { // Look
                const prevX = touches[t.identifier].lastX || t.clientX;
                const prevY = touches[t.identifier].lastY || t.clientY;
                input.lookX = (t.clientX - prevX) * LOOK_SENSITIVITY; 
                input.lookY = (t.clientY - prevY) * LOOK_SENSITIVITY;
                touches[t.identifier].lastX = t.clientX;
                touches[t.identifier].lastY = t.clientY;
                rightNub.style.transform = `translate(calc(-50% + ${Math.max(-20,Math.min(20,deltaX))}px), calc(-50% + ${Math.max(-20,Math.min(20,deltaY))}px))`;
            }
        }
    }
    function endTouch(e) {
        let leftActive = false;
        const activeIds = Array.from(e.touches).map(t => t.identifier);
        for (let id in touches) {
            if (!activeIds.includes(parseInt(id))) {
                if (touches[id].startX < halfWidth) { input.moveX = 0; input.moveY = 0; leftNub.style.transform = `translate(-50%, -50%)`; }
                delete touches[id];
            }
        }
    }

    // --- 3. LEVEL CONSTRUCTION ---
    const textureLoader = new THREE.TextureLoader();
    function createTexture(color, noise) {
        const canvas = document.createElement('canvas'); canvas.width=64; canvas.height=64;
        const ctx = canvas.getContext('2d'); 
        ctx.fillStyle = color; ctx.fillRect(0,0,64,64);
        if(noise) { for(let i=0;i<200;i++){ ctx.fillStyle=`rgba(0,0,0,${Math.random()*0.2})`; ctx.fillRect(Math.random()*64,Math.random()*64,2,2); } }
        return new THREE.CanvasTexture(canvas);
    }

    // Materials
    const matWall = new THREE.MeshStandardMaterial({ map: createTexture('#555555', true), roughness: 0.7 });
    const matFloor = new THREE.MeshStandardMaterial({ map: createTexture('#222222', true), roughness: 0.8 });
    const matRedWall = new THREE.MeshStandardMaterial({ map: createTexture('#880000', true), roughness: 0.5 });
    const matRedFloor = new THREE.MeshStandardMaterial({ map: createTexture('#440000', true), roughness: 0.6 });
    const matDoor = new THREE.MeshStandardMaterial({ map: createTexture('#334455', false), roughness: 0.2, metalness: 0.8 });

    const TILE_SIZE = 5;
    const lights = [];

    // Helper: Build a room/hallway segment
    function buildHall(x, z, w, d, floorMat, wallMat, h) {
        // Floor
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(w, d), floorMat);
        floor.rotation.x = -Math.PI/2;
        floor.position.set(x, h, z);
        floor.receiveShadow = true;
        scene.add(floor);

        // Ceiling
        const ceil = new THREE.Mesh(new THREE.PlaneGeometry(w, d), wallMat);
        ceil.rotation.x = Math.PI/2;
        ceil.position.set(x, h + TILE_SIZE, z);
        scene.add(ceil);

        // Walls (Simple block approach)
        const wallGeoSides = new THREE.BoxGeometry(1, TILE_SIZE, d);
        const wallGeoEnds = new THREE.BoxGeometry(w, TILE_SIZE, 1);

        // Left/Right Walls
        const w1 = new THREE.Mesh(wallGeoSides, wallMat); w1.position.set(x - w/2 - 0.5, h + TILE_SIZE/2, z); scene.add(w1);
        const w2 = new THREE.Mesh(wallGeoSides, wallMat); w2.position.set(x + w/2 + 0.5, h + TILE_SIZE/2, z); scene.add(w2);
    }

    // --- GENERATE ZONES ---
    
    // ZONE 1: Main Hall (Grey)
    // Z: 5 to -50
    buildHall(0, -22.5, TILE_SIZE, 55, matFloor, matWall, 0);
    // Add Torches
    addLight(0, 3, -10, 0xffaa00, 10);
    addLight(0, 3, -30, 0xffaa00, 10);
    
    // Ghost at end of Main Hall
    // (We put a wall at Z = -50 for the end)
    const endWall = new THREE.Mesh(new THREE.BoxGeometry(TILE_SIZE, TILE_SIZE, 1), matWall);
    endWall.position.set(0, TILE_SIZE/2, -50.5);
    scene.add(endWall);

    // ZONE 2: Left Branch (Grey)
    // Starts at Z=-25, goes Left (-X) to -40
    // We need to punch a hole in the Main Hall wall at Z=-25, X=-2.5. 
    // (Simplified: We just place the new hall and let it clip, collision handles the "hole")
    buildHall(-20, -25, 35, TILE_SIZE, matFloor, matWall, 0);
    addLight(-20, 3, -25, 0xffaa00, 8);

    // ZONE 3: The Door (At X = -40, Z = -25)
    const doorMesh = new THREE.Mesh(new THREE.BoxGeometry(1, TILE_SIZE-0.5, TILE_SIZE-0.5), matDoor);
    doorMesh.position.set(-38, TILE_SIZE/2, -25);
    scene.add(doorMesh);

    // ZONE 4: Stairs (Going down)
    // Starts X = -40, goes to -60. Y drops from 0 to -10.
    // We build individual steps
    for(let i=0; i<10; i++) {
        const sx = -42 - (i * 2); // Moving left
        const sy = -1 - i;        // Moving down
        const step = new THREE.Mesh(new THREE.BoxGeometry(2, 1, TILE_SIZE), matRedFloor);
        step
